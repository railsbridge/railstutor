<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html 
     PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
     "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
  <title>Module: TimelogHelper</title>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <meta http-equiv="Content-Script-Type" content="text/javascript" />
  <link rel="stylesheet" href=".././rdoc-style.css" type="text/css" media="screen" />
  <script type="text/javascript">
  // <![CDATA[

  function popupCode( url ) {
    window.open(url, "Code", "resizable=yes,scrollbars=yes,toolbar=no,status=no,height=150,width=400")
  }

  function toggleCode( id ) {
    if ( document.getElementById )
      elem = document.getElementById( id );
    else if ( document.all )
      elem = eval( "document.all." + id );
    else
      return false;

    elemStyle = elem.style;
    
    if ( elemStyle.display != "block" ) {
      elemStyle.display = "block"
    } else {
      elemStyle.display = "none"
    }

    return true;
  }
  
  // Make codeblocks hidden by default
  document.writeln( "<style type=\"text/css\">div.method-source-code { display: none }</style>" )
  
  // ]]>
  </script>

</head>
<body>



    <div id="classHeader">
        <table class="header-table">
        <tr class="top-aligned-row">
          <td><strong>Module</strong></td>
          <td class="class-name-in-header">TimelogHelper</td>
        </tr>
        <tr class="top-aligned-row">
            <td><strong>In:</strong></td>
            <td>
                <a href="../files/app/helpers/timelog_helper_rb.html">
                app/helpers/timelog_helper.rb
                </a>
        <br />
            </td>
        </tr>

        </table>
    </div>
  <!-- banner header -->

  <div id="bodyContent">



  <div id="contextContent">

    <div id="description">
      <p>
redMine - project management software Copyright (C) 2006 Jean-Philippe Lang
</p>
<p>
This program is free software; you can redistribute it and/or modify it
under the terms of the GNU General Public License as published by the Free
Software Foundation; either version 2 of the License, or (at your option)
any later version.
</p>
<p>
This program is distributed in the hope that it will be useful, but WITHOUT
ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
FITNESS FOR A PARTICULAR PURPOSE. See the GNU General Public License for
more details.
</p>
<p>
You should have received a copy of the GNU General Public License along
with this program; if not, write to the Free Software Foundation, Inc., 51
Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.
</p>

    </div>


   </div>

    <div id="method-list">
      <h3 class="section-bar">Methods</h3>

      <div class="name-list">
      <a href="#M001119">activity_collection_for_select_options</a>&nbsp;&nbsp;
      <a href="#M001123">entries_to_csv</a>&nbsp;&nbsp;
      <a href="#M001124">format_criteria_value</a>&nbsp;&nbsp;
      <a href="#M001122">options_for_period_select</a>&nbsp;&nbsp;
      <a href="#M001118">render_timelog_breadcrumb</a>&nbsp;&nbsp;
      <a href="#M001126">report_criteria_to_csv</a>&nbsp;&nbsp;
      <a href="#M001125">report_to_csv</a>&nbsp;&nbsp;
      <a href="#M001120">select_hours</a>&nbsp;&nbsp;
      <a href="#M001121">sum_hours</a>&nbsp;&nbsp;
      <a href="#M001127">to_utf8</a>&nbsp;&nbsp;
      </div>
    </div>

  </div>


    <!-- if includes -->
    <div id="includes">
      <h3 class="section-bar">Included Modules</h3>

      <div id="includes-list">
        <span class="include-name"><a href="ApplicationHelper.html">ApplicationHelper</a></span>
      </div>
    </div>

    <div id="section">





      


    <!-- if method_list -->
    <div id="methods">
      <h3 class="section-bar">Public Instance methods</h3>

      <div id="method-M001119" class="method-detail">
        <a name="M001119"></a>

        <div class="method-heading">
          <a href="#M001119" class="method-signature">
          <span class="method-name">activity_collection_for_select_options</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M001119-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M001119-source">
<pre>
    <span class="ruby-comment cmt"># File app/helpers/timelog_helper.rb, line 29</span>
29:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">activity_collection_for_select_options</span>
30:     <span class="ruby-identifier">activities</span> = <span class="ruby-constant">TimeEntryActivity</span>.<span class="ruby-identifier">all</span>
31:     <span class="ruby-identifier">collection</span> = []
32:     <span class="ruby-identifier">collection</span> <span class="ruby-operator">&lt;&lt;</span> [ <span class="ruby-node">&quot;--- #{l(:actionview_instancetag_blank_option)} ---&quot;</span>, <span class="ruby-value str">''</span> ] <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">activities</span>.<span class="ruby-identifier">detect</span>(<span class="ruby-operator">&amp;</span><span class="ruby-identifier">:is_default</span>)
33:     <span class="ruby-identifier">activities</span>.<span class="ruby-identifier">each</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">a</span><span class="ruby-operator">|</span> <span class="ruby-identifier">collection</span> <span class="ruby-operator">&lt;&lt;</span> [<span class="ruby-identifier">a</span>.<span class="ruby-identifier">name</span>, <span class="ruby-identifier">a</span>.<span class="ruby-identifier">id</span>] }
34:     <span class="ruby-identifier">collection</span>
35:   <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M001123" class="method-detail">
        <a name="M001123"></a>

        <div class="method-heading">
          <a href="#M001123" class="method-signature">
          <span class="method-name">entries_to_csv</span><span class="method-args">(entries)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M001123-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M001123-source">
<pre>
     <span class="ruby-comment cmt"># File app/helpers/timelog_helper.rb, line 67</span>
 67:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">entries_to_csv</span>(<span class="ruby-identifier">entries</span>)
 68:     <span class="ruby-identifier">ic</span> = <span class="ruby-constant">Iconv</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">l</span>(<span class="ruby-identifier">:general_csv_encoding</span>), <span class="ruby-value str">'UTF-8'</span>)    
 69:     <span class="ruby-identifier">decimal_separator</span> = <span class="ruby-identifier">l</span>(<span class="ruby-identifier">:general_csv_decimal_separator</span>)
 70:     <span class="ruby-identifier">custom_fields</span> = <span class="ruby-constant">TimeEntryCustomField</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">:all</span>)
 71:     <span class="ruby-identifier">export</span> = <span class="ruby-constant">StringIO</span>.<span class="ruby-identifier">new</span>
 72:     <span class="ruby-constant">CSV</span><span class="ruby-operator">::</span><span class="ruby-constant">Writer</span>.<span class="ruby-identifier">generate</span>(<span class="ruby-identifier">export</span>, <span class="ruby-identifier">l</span>(<span class="ruby-identifier">:general_csv_separator</span>)) <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">csv</span><span class="ruby-operator">|</span>
 73:       <span class="ruby-comment cmt"># csv header fields</span>
 74:       <span class="ruby-identifier">headers</span> = [<span class="ruby-identifier">l</span>(<span class="ruby-identifier">:field_spent_on</span>),
 75:                  <span class="ruby-identifier">l</span>(<span class="ruby-identifier">:field_user</span>),
 76:                  <span class="ruby-identifier">l</span>(<span class="ruby-identifier">:field_activity</span>),
 77:                  <span class="ruby-identifier">l</span>(<span class="ruby-identifier">:field_project</span>),
 78:                  <span class="ruby-identifier">l</span>(<span class="ruby-identifier">:field_issue</span>),
 79:                  <span class="ruby-identifier">l</span>(<span class="ruby-identifier">:field_tracker</span>),
 80:                  <span class="ruby-identifier">l</span>(<span class="ruby-identifier">:field_subject</span>),
 81:                  <span class="ruby-identifier">l</span>(<span class="ruby-identifier">:field_hours</span>),
 82:                  <span class="ruby-identifier">l</span>(<span class="ruby-identifier">:field_comments</span>)
 83:                  ]
 84:       <span class="ruby-comment cmt"># Export custom fields</span>
 85:       <span class="ruby-identifier">headers</span> <span class="ruby-operator">+=</span> <span class="ruby-identifier">custom_fields</span>.<span class="ruby-identifier">collect</span>(<span class="ruby-operator">&amp;</span><span class="ruby-identifier">:name</span>)
 86:       
 87:       <span class="ruby-identifier">csv</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">headers</span>.<span class="ruby-identifier">collect</span> {<span class="ruby-operator">|</span><span class="ruby-identifier">c</span><span class="ruby-operator">|</span> <span class="ruby-keyword kw">begin</span>; <span class="ruby-identifier">ic</span>.<span class="ruby-identifier">iconv</span>(<span class="ruby-identifier">c</span>.<span class="ruby-identifier">to_s</span>); <span class="ruby-keyword kw">rescue</span>; <span class="ruby-identifier">c</span>.<span class="ruby-identifier">to_s</span>; <span class="ruby-keyword kw">end</span> }
 88:       <span class="ruby-comment cmt"># csv lines</span>
 89:       <span class="ruby-identifier">entries</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">entry</span><span class="ruby-operator">|</span>
 90:         <span class="ruby-identifier">fields</span> = [<span class="ruby-identifier">format_date</span>(<span class="ruby-identifier">entry</span>.<span class="ruby-identifier">spent_on</span>),
 91:                   <span class="ruby-identifier">entry</span>.<span class="ruby-identifier">user</span>,
 92:                   <span class="ruby-identifier">entry</span>.<span class="ruby-identifier">activity</span>,
 93:                   <span class="ruby-identifier">entry</span>.<span class="ruby-identifier">project</span>,
 94:                   (<span class="ruby-identifier">entry</span>.<span class="ruby-identifier">issue</span> <span class="ruby-value">? </span><span class="ruby-identifier">entry</span>.<span class="ruby-identifier">issue</span>.<span class="ruby-identifier">id</span> <span class="ruby-operator">:</span> <span class="ruby-keyword kw">nil</span>),
 95:                   (<span class="ruby-identifier">entry</span>.<span class="ruby-identifier">issue</span> <span class="ruby-value">? </span><span class="ruby-identifier">entry</span>.<span class="ruby-identifier">issue</span>.<span class="ruby-identifier">tracker</span> <span class="ruby-operator">:</span> <span class="ruby-keyword kw">nil</span>),
 96:                   (<span class="ruby-identifier">entry</span>.<span class="ruby-identifier">issue</span> <span class="ruby-value">? </span><span class="ruby-identifier">entry</span>.<span class="ruby-identifier">issue</span>.<span class="ruby-identifier">subject</span> <span class="ruby-operator">:</span> <span class="ruby-keyword kw">nil</span>),
 97:                   <span class="ruby-identifier">entry</span>.<span class="ruby-identifier">hours</span>.<span class="ruby-identifier">to_s</span>.<span class="ruby-identifier">gsub</span>(<span class="ruby-value str">'.'</span>, <span class="ruby-identifier">decimal_separator</span>),
 98:                   <span class="ruby-identifier">entry</span>.<span class="ruby-identifier">comments</span>
 99:                   ]
100:         <span class="ruby-identifier">fields</span> <span class="ruby-operator">+=</span> <span class="ruby-identifier">custom_fields</span>.<span class="ruby-identifier">collect</span> {<span class="ruby-operator">|</span><span class="ruby-identifier">f</span><span class="ruby-operator">|</span> <span class="ruby-identifier">show_value</span>(<span class="ruby-identifier">entry</span>.<span class="ruby-identifier">custom_value_for</span>(<span class="ruby-identifier">f</span>)) }
101:                   
102:         <span class="ruby-identifier">csv</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">fields</span>.<span class="ruby-identifier">collect</span> {<span class="ruby-operator">|</span><span class="ruby-identifier">c</span><span class="ruby-operator">|</span> <span class="ruby-keyword kw">begin</span>; <span class="ruby-identifier">ic</span>.<span class="ruby-identifier">iconv</span>(<span class="ruby-identifier">c</span>.<span class="ruby-identifier">to_s</span>); <span class="ruby-keyword kw">rescue</span>; <span class="ruby-identifier">c</span>.<span class="ruby-identifier">to_s</span>; <span class="ruby-keyword kw">end</span> }
103:       <span class="ruby-keyword kw">end</span>
104:     <span class="ruby-keyword kw">end</span>
105:     <span class="ruby-identifier">export</span>.<span class="ruby-identifier">rewind</span>
106:     <span class="ruby-identifier">export</span>
107:   <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M001124" class="method-detail">
        <a name="M001124"></a>

        <div class="method-heading">
          <a href="#M001124" class="method-signature">
          <span class="method-name">format_criteria_value</span><span class="method-args">(criteria, value)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M001124-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M001124-source">
<pre>
     <span class="ruby-comment cmt"># File app/helpers/timelog_helper.rb, line 109</span>
109:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">format_criteria_value</span>(<span class="ruby-identifier">criteria</span>, <span class="ruby-identifier">value</span>)
110:     <span class="ruby-identifier">value</span>.<span class="ruby-identifier">blank?</span> <span class="ruby-value">? </span><span class="ruby-identifier">l</span>(<span class="ruby-identifier">:label_none</span>) <span class="ruby-operator">:</span> ((<span class="ruby-identifier">k</span> = <span class="ruby-ivar">@available_criterias</span>[<span class="ruby-identifier">criteria</span>][<span class="ruby-identifier">:klass</span>]) <span class="ruby-operator">?</span> <span class="ruby-identifier">k</span>.<span class="ruby-identifier">find_by_id</span>(<span class="ruby-identifier">value</span>.<span class="ruby-identifier">to_i</span>) <span class="ruby-operator">:</span> <span class="ruby-identifier">format_value</span>(<span class="ruby-identifier">value</span>, <span class="ruby-ivar">@available_criterias</span>[<span class="ruby-identifier">criteria</span>][<span class="ruby-identifier">:format</span>]))
111:   <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M001122" class="method-detail">
        <a name="M001122"></a>

        <div class="method-heading">
          <a href="#M001122" class="method-signature">
          <span class="method-name">options_for_period_select</span><span class="method-args">(value)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M001122-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M001122-source">
<pre>
    <span class="ruby-comment cmt"># File app/helpers/timelog_helper.rb, line 53</span>
53:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">options_for_period_select</span>(<span class="ruby-identifier">value</span>)
54:     <span class="ruby-identifier">options_for_select</span>([[<span class="ruby-identifier">l</span>(<span class="ruby-identifier">:label_all_time</span>), <span class="ruby-value str">'all'</span>],
55:                         [<span class="ruby-identifier">l</span>(<span class="ruby-identifier">:label_today</span>), <span class="ruby-value str">'today'</span>],
56:                         [<span class="ruby-identifier">l</span>(<span class="ruby-identifier">:label_yesterday</span>), <span class="ruby-value str">'yesterday'</span>],
57:                         [<span class="ruby-identifier">l</span>(<span class="ruby-identifier">:label_this_week</span>), <span class="ruby-value str">'current_week'</span>],
58:                         [<span class="ruby-identifier">l</span>(<span class="ruby-identifier">:label_last_week</span>), <span class="ruby-value str">'last_week'</span>],
59:                         [<span class="ruby-identifier">l</span>(<span class="ruby-identifier">:label_last_n_days</span>, <span class="ruby-value">7</span>), <span class="ruby-value str">'7_days'</span>],
60:                         [<span class="ruby-identifier">l</span>(<span class="ruby-identifier">:label_this_month</span>), <span class="ruby-value str">'current_month'</span>],
61:                         [<span class="ruby-identifier">l</span>(<span class="ruby-identifier">:label_last_month</span>), <span class="ruby-value str">'last_month'</span>],
62:                         [<span class="ruby-identifier">l</span>(<span class="ruby-identifier">:label_last_n_days</span>, <span class="ruby-value">30</span>), <span class="ruby-value str">'30_days'</span>],
63:                         [<span class="ruby-identifier">l</span>(<span class="ruby-identifier">:label_this_year</span>), <span class="ruby-value str">'current_year'</span>]],
64:                         <span class="ruby-identifier">value</span>)
65:   <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M001118" class="method-detail">
        <a name="M001118"></a>

        <div class="method-heading">
          <a href="#M001118" class="method-signature">
          <span class="method-name">render_timelog_breadcrumb</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M001118-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M001118-source">
<pre>
    <span class="ruby-comment cmt"># File app/helpers/timelog_helper.rb, line 21</span>
21:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">render_timelog_breadcrumb</span>
22:     <span class="ruby-identifier">links</span> = []
23:     <span class="ruby-identifier">links</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">link_to</span>(<span class="ruby-identifier">l</span>(<span class="ruby-identifier">:label_project_all</span>), {<span class="ruby-identifier">:project_id</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-keyword kw">nil</span>, <span class="ruby-identifier">:issue_id</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-keyword kw">nil</span>})
24:     <span class="ruby-identifier">links</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">link_to</span>(<span class="ruby-identifier">h</span>(<span class="ruby-ivar">@project</span>), {<span class="ruby-identifier">:project_id</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-ivar">@project</span>, <span class="ruby-identifier">:issue_id</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-keyword kw">nil</span>}) <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@project</span>
25:     <span class="ruby-identifier">links</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">link_to_issue</span>(<span class="ruby-ivar">@issue</span>) <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@issue</span>
26:     <span class="ruby-identifier">breadcrumb</span> <span class="ruby-identifier">links</span>
27:   <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M001126" class="method-detail">
        <a name="M001126"></a>

        <div class="method-heading">
          <a href="#M001126" class="method-signature">
          <span class="method-name">report_criteria_to_csv</span><span class="method-args">(csv, criterias, periods, hours, level=0)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M001126-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M001126-source">
<pre>
     <span class="ruby-comment cmt"># File app/helpers/timelog_helper.rb, line 138</span>
138:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">report_criteria_to_csv</span>(<span class="ruby-identifier">csv</span>, <span class="ruby-identifier">criterias</span>, <span class="ruby-identifier">periods</span>, <span class="ruby-identifier">hours</span>, <span class="ruby-identifier">level</span>=<span class="ruby-value">0</span>)
139:     <span class="ruby-identifier">hours</span>.<span class="ruby-identifier">collect</span> {<span class="ruby-operator">|</span><span class="ruby-identifier">h</span><span class="ruby-operator">|</span> <span class="ruby-identifier">h</span>[<span class="ruby-identifier">criterias</span>[<span class="ruby-identifier">level</span>]].<span class="ruby-identifier">to_s</span>}.<span class="ruby-identifier">uniq</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">value</span><span class="ruby-operator">|</span>
140:       <span class="ruby-identifier">hours_for_value</span> = <span class="ruby-identifier">select_hours</span>(<span class="ruby-identifier">hours</span>, <span class="ruby-identifier">criterias</span>[<span class="ruby-identifier">level</span>], <span class="ruby-identifier">value</span>)
141:       <span class="ruby-keyword kw">next</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">hours_for_value</span>.<span class="ruby-identifier">empty?</span>
142:       <span class="ruby-identifier">row</span> = [<span class="ruby-value str">''</span>] <span class="ruby-operator">*</span> <span class="ruby-identifier">level</span>
143:       <span class="ruby-identifier">row</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">to_utf8</span>(<span class="ruby-identifier">format_criteria_value</span>(<span class="ruby-identifier">criterias</span>[<span class="ruby-identifier">level</span>], <span class="ruby-identifier">value</span>))
144:       <span class="ruby-identifier">row</span> <span class="ruby-operator">+=</span> [<span class="ruby-value str">''</span>] <span class="ruby-operator">*</span> (<span class="ruby-identifier">criterias</span>.<span class="ruby-identifier">length</span> <span class="ruby-operator">-</span> <span class="ruby-identifier">level</span> <span class="ruby-operator">-</span> <span class="ruby-value">1</span>)
145:       <span class="ruby-identifier">total</span> = <span class="ruby-value">0</span>
146:       <span class="ruby-identifier">periods</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">period</span><span class="ruby-operator">|</span>
147:         <span class="ruby-identifier">sum</span> = <span class="ruby-identifier">sum_hours</span>(<span class="ruby-identifier">select_hours</span>(<span class="ruby-identifier">hours_for_value</span>, <span class="ruby-ivar">@columns</span>, <span class="ruby-identifier">period</span>.<span class="ruby-identifier">to_s</span>))
148:         <span class="ruby-identifier">total</span> <span class="ruby-operator">+=</span> <span class="ruby-identifier">sum</span>
149:         <span class="ruby-identifier">row</span> <span class="ruby-operator">&lt;&lt;</span> (<span class="ruby-identifier">sum</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">0</span> <span class="ruby-operator">?</span> <span class="ruby-value str">&quot;%.2f&quot;</span> <span class="ruby-operator">%</span> <span class="ruby-identifier">sum</span> <span class="ruby-operator">:</span> <span class="ruby-value str">''</span>)
150:       <span class="ruby-keyword kw">end</span>
151:       <span class="ruby-identifier">row</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-value str">&quot;%.2f&quot;</span> <span class="ruby-operator">%</span><span class="ruby-identifier">total</span>
152:       <span class="ruby-identifier">csv</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">row</span>
153:       
154:       <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">criterias</span>.<span class="ruby-identifier">length</span> <span class="ruby-operator">&gt;</span> <span class="ruby-identifier">level</span> <span class="ruby-operator">+</span> <span class="ruby-value">1</span>
155:         <span class="ruby-identifier">report_criteria_to_csv</span>(<span class="ruby-identifier">csv</span>, <span class="ruby-identifier">criterias</span>, <span class="ruby-identifier">periods</span>, <span class="ruby-identifier">hours_for_value</span>, <span class="ruby-identifier">level</span> <span class="ruby-operator">+</span> <span class="ruby-value">1</span>)
156:       <span class="ruby-keyword kw">end</span>
157:     <span class="ruby-keyword kw">end</span>
158:   <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M001125" class="method-detail">
        <a name="M001125"></a>

        <div class="method-heading">
          <a href="#M001125" class="method-signature">
          <span class="method-name">report_to_csv</span><span class="method-args">(criterias, periods, hours)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M001125-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M001125-source">
<pre>
     <span class="ruby-comment cmt"># File app/helpers/timelog_helper.rb, line 113</span>
113:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">report_to_csv</span>(<span class="ruby-identifier">criterias</span>, <span class="ruby-identifier">periods</span>, <span class="ruby-identifier">hours</span>)
114:     <span class="ruby-identifier">export</span> = <span class="ruby-constant">StringIO</span>.<span class="ruby-identifier">new</span>
115:     <span class="ruby-constant">CSV</span><span class="ruby-operator">::</span><span class="ruby-constant">Writer</span>.<span class="ruby-identifier">generate</span>(<span class="ruby-identifier">export</span>, <span class="ruby-identifier">l</span>(<span class="ruby-identifier">:general_csv_separator</span>)) <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">csv</span><span class="ruby-operator">|</span>
116:       <span class="ruby-comment cmt"># Column headers</span>
117:       <span class="ruby-identifier">headers</span> = <span class="ruby-identifier">criterias</span>.<span class="ruby-identifier">collect</span> {<span class="ruby-operator">|</span><span class="ruby-identifier">criteria</span><span class="ruby-operator">|</span> <span class="ruby-identifier">l</span>(<span class="ruby-ivar">@available_criterias</span>[<span class="ruby-identifier">criteria</span>][<span class="ruby-identifier">:label</span>]) }
118:       <span class="ruby-identifier">headers</span> <span class="ruby-operator">+=</span> <span class="ruby-identifier">periods</span>
119:       <span class="ruby-identifier">headers</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">l</span>(<span class="ruby-identifier">:label_total</span>)
120:       <span class="ruby-identifier">csv</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">headers</span>.<span class="ruby-identifier">collect</span> {<span class="ruby-operator">|</span><span class="ruby-identifier">c</span><span class="ruby-operator">|</span> <span class="ruby-identifier">to_utf8</span>(<span class="ruby-identifier">c</span>) }
121:       <span class="ruby-comment cmt"># Content</span>
122:       <span class="ruby-identifier">report_criteria_to_csv</span>(<span class="ruby-identifier">csv</span>, <span class="ruby-identifier">criterias</span>, <span class="ruby-identifier">periods</span>, <span class="ruby-identifier">hours</span>)
123:       <span class="ruby-comment cmt"># Total row</span>
124:       <span class="ruby-identifier">row</span> = [ <span class="ruby-identifier">l</span>(<span class="ruby-identifier">:label_total</span>) ] <span class="ruby-operator">+</span> [<span class="ruby-value str">''</span>] <span class="ruby-operator">*</span> (<span class="ruby-identifier">criterias</span>.<span class="ruby-identifier">size</span> <span class="ruby-operator">-</span> <span class="ruby-value">1</span>)
125:       <span class="ruby-identifier">total</span> = <span class="ruby-value">0</span>
126:       <span class="ruby-identifier">periods</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">period</span><span class="ruby-operator">|</span>
127:         <span class="ruby-identifier">sum</span> = <span class="ruby-identifier">sum_hours</span>(<span class="ruby-identifier">select_hours</span>(<span class="ruby-identifier">hours</span>, <span class="ruby-ivar">@columns</span>, <span class="ruby-identifier">period</span>.<span class="ruby-identifier">to_s</span>))
128:         <span class="ruby-identifier">total</span> <span class="ruby-operator">+=</span> <span class="ruby-identifier">sum</span>
129:         <span class="ruby-identifier">row</span> <span class="ruby-operator">&lt;&lt;</span> (<span class="ruby-identifier">sum</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">0</span> <span class="ruby-operator">?</span> <span class="ruby-value str">&quot;%.2f&quot;</span> <span class="ruby-operator">%</span> <span class="ruby-identifier">sum</span> <span class="ruby-operator">:</span> <span class="ruby-value str">''</span>)
130:       <span class="ruby-keyword kw">end</span>
131:       <span class="ruby-identifier">row</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-value str">&quot;%.2f&quot;</span> <span class="ruby-operator">%</span><span class="ruby-identifier">total</span>
132:       <span class="ruby-identifier">csv</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">row</span>
133:     <span class="ruby-keyword kw">end</span>
134:     <span class="ruby-identifier">export</span>.<span class="ruby-identifier">rewind</span>
135:     <span class="ruby-identifier">export</span>
136:   <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M001120" class="method-detail">
        <a name="M001120"></a>

        <div class="method-heading">
          <a href="#M001120" class="method-signature">
          <span class="method-name">select_hours</span><span class="method-args">(data, criteria, value)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M001120-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M001120-source">
<pre>
    <span class="ruby-comment cmt"># File app/helpers/timelog_helper.rb, line 37</span>
37:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">select_hours</span>(<span class="ruby-identifier">data</span>, <span class="ruby-identifier">criteria</span>, <span class="ruby-identifier">value</span>)
38:         <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">value</span>.<span class="ruby-identifier">to_s</span>.<span class="ruby-identifier">empty?</span>
39:                 <span class="ruby-identifier">data</span>.<span class="ruby-identifier">select</span> {<span class="ruby-operator">|</span><span class="ruby-identifier">row</span><span class="ruby-operator">|</span> <span class="ruby-identifier">row</span>[<span class="ruby-identifier">criteria</span>].<span class="ruby-identifier">blank?</span> }
40:     <span class="ruby-keyword kw">else</span> 
41:         <span class="ruby-identifier">data</span>.<span class="ruby-identifier">select</span> {<span class="ruby-operator">|</span><span class="ruby-identifier">row</span><span class="ruby-operator">|</span> <span class="ruby-identifier">row</span>[<span class="ruby-identifier">criteria</span>] <span class="ruby-operator">==</span> <span class="ruby-identifier">value</span>}
42:     <span class="ruby-keyword kw">end</span>
43:   <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M001121" class="method-detail">
        <a name="M001121"></a>

        <div class="method-heading">
          <a href="#M001121" class="method-signature">
          <span class="method-name">sum_hours</span><span class="method-args">(data)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M001121-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M001121-source">
<pre>
    <span class="ruby-comment cmt"># File app/helpers/timelog_helper.rb, line 45</span>
45:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">sum_hours</span>(<span class="ruby-identifier">data</span>)
46:     <span class="ruby-identifier">sum</span> = <span class="ruby-value">0</span>
47:     <span class="ruby-identifier">data</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">row</span><span class="ruby-operator">|</span>
48:       <span class="ruby-identifier">sum</span> <span class="ruby-operator">+=</span> <span class="ruby-identifier">row</span>[<span class="ruby-value str">'hours'</span>].<span class="ruby-identifier">to_f</span>
49:     <span class="ruby-keyword kw">end</span>
50:     <span class="ruby-identifier">sum</span>
51:   <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M001127" class="method-detail">
        <a name="M001127"></a>

        <div class="method-heading">
          <a href="#M001127" class="method-signature">
          <span class="method-name">to_utf8</span><span class="method-args">(s)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M001127-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M001127-source">
<pre>
     <span class="ruby-comment cmt"># File app/helpers/timelog_helper.rb, line 160</span>
160:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">to_utf8</span>(<span class="ruby-identifier">s</span>)
161:     <span class="ruby-ivar">@ic</span> <span class="ruby-operator">||=</span> <span class="ruby-constant">Iconv</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">l</span>(<span class="ruby-identifier">:general_csv_encoding</span>), <span class="ruby-value str">'UTF-8'</span>)
162:     <span class="ruby-keyword kw">begin</span>; <span class="ruby-ivar">@ic</span>.<span class="ruby-identifier">iconv</span>(<span class="ruby-identifier">s</span>.<span class="ruby-identifier">to_s</span>); <span class="ruby-keyword kw">rescue</span>; <span class="ruby-identifier">s</span>.<span class="ruby-identifier">to_s</span>; <span class="ruby-keyword kw">end</span>
163:   <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>


    </div>


  </div>


<div id="validator-badges">
  <p><small><a href="http://validator.w3.org/check/referer">[Validate]</a></small></p>
</div>

</body>
</html>